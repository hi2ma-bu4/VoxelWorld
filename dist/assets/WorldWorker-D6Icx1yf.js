(function(){"use strict";function H(e,t,n){return e+n*16+t*16*16}let a;function U(e){const t=typeof e;if(t=="number"||t=="boolean"||e==null)return`${e}`;if(t=="string")return`"${e}"`;if(t=="symbol"){const r=e.description;return r==null?"Symbol":`Symbol(${r})`}if(t=="function"){const r=e.name;return typeof r=="string"&&r.length>0?`Function(${r})`:"Function"}if(Array.isArray(e)){const r=e.length;let s="[";r>0&&(s+=U(e[0]));for(let i=1;i<r;i++)s+=", "+U(e[i]);return s+="]",s}const n=/\[object ([^\]]+)\]/.exec(toString.call(e));let o;if(n&&n.length>1)o=n[1];else return toString.call(e);if(o=="Object")try{return"Object("+JSON.stringify(e)+")"}catch{return"Object"}return e instanceof Error?`${e.name}: ${e.message}
${e.stack}`:o}let w=0,g=null;function d(){return(g===null||g.byteLength===0)&&(g=new Uint8Array(a.memory.buffer)),g}const y=new TextEncoder;"encodeInto"in y||(y.encodeInto=function(e,t){const n=y.encode(e);return t.set(n),{read:e.length,written:n.length}});function N(e,t,n){if(n===void 0){const c=y.encode(e),_=t(c.length,1)>>>0;return d().subarray(_,_+c.length).set(c),w=c.length,_}let o=e.length,r=t(o,1)>>>0;const s=d();let i=0;for(;i<o;i++){const c=e.charCodeAt(i);if(c>127)break;s[r+i]=c}if(i!==o){i!==0&&(e=e.slice(i)),r=n(r,o,o=i+e.length*3,1)>>>0;const c=d().subarray(r+i,r+o),_=y.encodeInto(e,c);i+=_.written,r=n(r,o,i,1)>>>0}return w=i,r}let b=null;function p(){return(b===null||b.buffer.detached===!0||b.buffer.detached===void 0&&b.buffer!==a.memory.buffer)&&(b=new DataView(a.memory.buffer)),b}let S=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});S.decode();const F=2146435072;let C=0;function K(e,t){return C+=t,C>=F&&(S=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),S.decode(),C=t),S.decode(d().subarray(e,e+t))}function I(e,t){return e=e>>>0,K(e,t)}let h=null;function O(){return(h===null||h.byteLength===0)&&(h=new Uint32Array(a.memory.buffer)),h}function R(e,t){return e=e>>>0,O().subarray(e/4,e/4+t)}let m=null;function T(){return(m===null||m.byteLength===0)&&(m=new Float32Array(a.memory.buffer)),m}function j(e,t){return e=e>>>0,T().subarray(e/4,e/4+t)}function L(e){const t=a.__externref_table_alloc();return a.__wbindgen_externrefs.set(t,e),t}function X(e,t){try{return e.apply(this,t)}catch(n){const o=L(n);a.__wbindgen_exn_store(o)}}function P(e,t){return e=e>>>0,d().subarray(e/1,e/1+t)}function z(e,t){const n=t(e.length*1,1)>>>0;return d().set(e,n/1),w=e.length,n}const x=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>a.__wbg_worldgenerator_free(e>>>0,1));class M{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,x.unregister(this),t}free(){const t=this.__destroy_into_raw();a.__wbg_worldgenerator_free(t,0)}constructor(t){const n=a.worldgenerator_new(t);return this.__wbg_ptr=n>>>0,x.register(this,this.__wbg_ptr,this),this}generate_chunk_data(t,n,o){const r=a.worldgenerator_generate_chunk_data(this.__wbg_ptr,t,n,o);var s=P(r[0],r[1]).slice();return a.__wbindgen_free(r[0],r[1]*1,1),s}generate_chunk_mesh(t){const n=z(t,a.__wbindgen_malloc),o=w;return a.worldgenerator_generate_chunk_mesh(this.__wbg_ptr,n,o)}}Symbol.dispose&&(M.prototype[Symbol.dispose]=M.prototype.free);const V=new Set(["basic","cors","default"]);async function Y(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.ok&&V.has(e.type)&&e.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function q(){const e={};return e.wbg={},e.wbg.__wbg___wbindgen_debug_string_df47ffb5e35e6763=function(t,n){const o=U(n),r=N(o,a.__wbindgen_malloc,a.__wbindgen_realloc),s=w;p().setInt32(t+4,s,!0),p().setInt32(t+0,r,!0)},e.wbg.__wbg___wbindgen_throw_b855445ff6a94295=function(t,n){throw new Error(I(t,n))},e.wbg.__wbg_buffer_0806a073be3767d2=function(t){return t.buffer},e.wbg.__wbg_buffer_789b8f97a1575553=function(t){return t.buffer},e.wbg.__wbg_error_7534b8e9a36f1ab4=function(t,n){let o,r;try{o=t,r=n,console.error(I(t,n))}finally{a.__wbindgen_free(o,r,1)}},e.wbg.__wbg_new_1acc0b6eea89d040=function(){return new Object},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},e.wbg.__wbg_new_from_slice_7943307099c96d15=function(t,n){return new Uint32Array(R(t,n))},e.wbg.__wbg_new_from_slice_924249b74d07c449=function(t,n){return new Float32Array(j(t,n))},e.wbg.__wbg_set_c2abbebe8b9ebee1=function(){return X(function(t,n,o){return Reflect.set(t,n,o)},arguments)},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(t,n){const o=n.stack,r=N(o,a.__wbindgen_malloc,a.__wbindgen_realloc),s=w;p().setInt32(t+4,s,!0),p().setInt32(t+0,r,!0)},e.wbg.__wbindgen_cast_2241b6af4c4b2941=function(t,n){return I(t,n)},e.wbg.__wbindgen_init_externref_table=function(){const t=a.__wbindgen_externrefs,n=t.grow(4);t.set(0,void 0),t.set(n+0,void 0),t.set(n+1,null),t.set(n+2,!0),t.set(n+3,!1)},e}function J(e,t){return a=e.exports,Z.__wbindgen_wasm_module=t,b=null,m=null,h=null,g=null,a.__wbindgen_start(),a}async function Z(e){if(a!==void 0)return a;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof e>"u"&&(e=new URL("/assets/voxel_world_bg-5HiELFSJ.wasm",self.location.href));const t=q();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await Y(await e,t);return J(n,o)}var G="/assets/voxel_world_bg-5HiELFSJ.wasm";const Q="MyVoxelWorldDB",v=1,f="chunks";class ee{db=null;async openDB(){return new Promise((t,n)=>{if(this.db){t();return}const o=indexedDB.open(Q,v);o.onerror=()=>{console.error("IndexedDB error:",o.error),n(new Error("Failed to open DB"))},o.onsuccess=r=>{this.db=r.target.result,t()},o.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(f)||s.createObjectStore(f,{keyPath:"key"})}})}async setChunk(t,n){return this.db||await this.openDB(),new Promise((o,r)=>{const c=this.db.transaction(f,"readwrite").objectStore(f).put({key:t,data:n});c.onsuccess=()=>o(),c.onerror=()=>r(c.error)})}async getChunk(t){return this.db||await this.openDB(),new Promise((n,o)=>{const i=this.db.transaction(f,"readonly").objectStore(f).get(t);i.onsuccess=()=>{n(i.result?i.result.data:null)},i.onerror=()=>o(i.error)})}async getAllChunks(){return this.db||await this.openDB(),new Promise((t,n)=>{const s=this.db.transaction(f,"readonly").objectStore(f).getAll();s.onsuccess=()=>{const i=new Map;for(const c of s.result)i.set(c.key,c.data);t(i)},s.onerror=()=>n(s.error)})}}console.log("Worker: スクリプト読み込み完了");let k=null;const D=new ee,u=new Map;async function W(){k||(console.log("Worker: WASMモジュール初期化開始..."),await Z(G),k=new M(12345),console.log("Worker: WASMモジュール初期化完了"))}async function te(){console.log("Worker: IndexedDBからワールド読み込み開始..."),await D.openDB();const e=await D.getAllChunks();e.forEach((n,o)=>{u.set(o,n)}),console.log(`Worker: ${e.size}個のチャンクをDBからキャッシュに読み込みました`);const t={type:"worldLoaded"};self.postMessage(t)}async function B(e,t,n){const o=`${e},${t},${n}`;if(u.has(o))return u.get(o);await W();const r=k.generate_chunk_data(e,t,n),s=new Uint8Array(r);return u.set(o,s),s}async function l(e,t,n){const o=`${e},${t},${n}`,r=await B(e,t,n);await W();const s=k.generate_chunk_mesh(r),i={type:"chunkMesh",chunkKey:o,mesh:s};self.postMessage(i,{transfer:[s.positions,s.normals,s.uvs,s.indices]})}async function ne(e,t,n,o){const r=Math.floor(e/16),s=Math.floor(t/16),i=Math.floor(n/16),c=e-r*16,_=t-s*16,E=n-i*16,A=await B(r,s,i),$=H(c,_,E);if($<0||$>=4096){console.error("setBlock: インデックスが範囲外です",{lx:c,ly:_,lz:E});return}A[$]!==o&&(A[$]=o,u.set(`${r},${s},${i}`,A),D.setChunk(`${r},${s},${i}`,A).catch(console.error),await l(r,s,i),c===0&&u.has(`${r-1},${s},${i}`)&&await l(r-1,s,i),c===15&&u.has(`${r+1},${s},${i}`)&&await l(r+1,s,i),_===0&&u.has(`${r},${s-1},${i}`)&&await l(r,s-1,i),_===15&&u.has(`${r},${s+1},${i}`)&&await l(r,s+1,i),E===0&&u.has(`${r},${s},${i-1}`)&&await l(r,s,i-1),E===15&&u.has(`${r},${s},${i+1}`)&&await l(r,s,i+1))}self.onmessage=async e=>{const t=e.data;try{switch(t.type){case"loadWorld":await W(),await te();break;case"generate":await l(t.chunkX,t.chunkY,t.chunkZ);break;case"setBlock":await ne(t.worldX,t.worldY,t.worldZ,t.blockId);break;case"saveWorld":console.log("Worker: (自動保存のため手動保存はスキップ)");break}}catch(n){console.error("Worker: メッセージ処理中にエラーが発生",n)}}})();
