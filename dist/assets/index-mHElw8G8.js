import{C as L,V as h,E as b,S as M,a as B,P,W as C,A as _,D as R,R as z,N as w,M as A,F as S,B as F,b as I,c as p,d as N,e as m,f as D,T as W}from"./three-DWauT3Cn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=t(o);fetch(o.href,n)}})();const l=new b(0,0,0,"YXZ"),d=new h,q={type:"change"},T={type:"lock"},O={type:"unlock"},k=.002,f=Math.PI/2;class H extends L{constructor(e,t=null){super(e,t),this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=U.bind(this),this._onPointerlockChange=Z.bind(this),this._onPointerlockError=Y.bind(this),this.domElement!==null&&this.connect(this.domElement)}connect(e){super.connect(e),this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getDirection(e){return e.set(0,0,-1).applyQuaternion(this.object.quaternion)}moveForward(e){if(this.enabled===!1)return;const t=this.object;d.setFromMatrixColumn(t.matrix,0),d.crossVectors(t.up,d),t.position.addScaledVector(d,e)}moveRight(e){if(this.enabled===!1)return;const t=this.object;d.setFromMatrixColumn(t.matrix,0),t.position.addScaledVector(d,e)}lock(e=!1){this.domElement.requestPointerLock({unadjustedMovement:e})}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function U(i){if(this.enabled===!1||this.isLocked===!1)return;const e=this.object;l.setFromQuaternion(e.quaternion),l.y-=i.movementX*k*this.pointerSpeed,l.x-=i.movementY*k*this.pointerSpeed,l.x=Math.max(f-this.maxPolarAngle,Math.min(f-this.minPolarAngle,l.x)),e.quaternion.setFromEuler(l),this.dispatchEvent(q)}function Z(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(T),this.isLocked=!0):(this.dispatchEvent(O),this.isLocked=!1)}function Y(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}class j{controls;velocity=new h;direction=new h;moveForward=!1;moveBackward=!1;moveLeft=!1;moveRight=!1;prevTime;constructor(e,t){this.controls=new H(e,t),this.prevTime=performance.now(),e.position.set(8,48,8),this.controls.addEventListener("lock",()=>{console.log("Pointer locked"),document.body.classList.add("locked")}),this.controls.addEventListener("unlock",()=>{console.log("Pointer unlocked"),document.body.classList.remove("locked")}),t.addEventListener("click",()=>{this.controls.isLocked||this.controls.lock()}),document.addEventListener("keydown",s=>this.onKeyDown(s.key)),document.addEventListener("keyup",s=>this.onKeyUp(s.key))}onKeyDown(e){switch(e.toLowerCase()){case"w":this.moveForward=!0;break;case"a":this.moveLeft=!0;break;case"s":this.moveBackward=!0;break;case"d":this.moveRight=!0;break}}onKeyUp(e){switch(e.toLowerCase()){case"w":this.moveForward=!1;break;case"a":this.moveLeft=!1;break;case"s":this.moveBackward=!1;break;case"d":this.moveRight=!1;break}}update(){if(!this.controls.isLocked)return;const e=performance.now(),t=(e-this.prevTime)/1e3,s=10,o=10;this.velocity.x-=this.velocity.x*o*t,this.velocity.z-=this.velocity.z*o*t,this.direction.z=Number(this.moveForward)-Number(this.moveBackward),this.direction.x=Number(this.moveRight)-Number(this.moveLeft),this.direction.normalize(),(this.moveForward||this.moveBackward)&&(this.velocity.z-=this.direction.z*s*o*t),(this.moveLeft||this.moveRight)&&(this.velocity.x-=this.direction.x*s*o*t),this.controls.moveRight(-this.velocity.x*t),this.controls.moveForward(-this.velocity.z*t),this.prevTime=e}}class K{scene;camera;renderer;canvas;constructor(e){this.canvas=e,this.scene=new M,this.scene.background=new B(8900331),this.camera=new P(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=new C({canvas:this.canvas,antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio);const t=new _(16777215,.6);this.scene.add(t);const s=new R(16777215,1);s.position.set(50,100,50),s.target.position.set(0,0,0),this.scene.add(s),window.addEventListener("resize",()=>this.onResize())}onResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}render(e){e.update(),this.renderer.render(this.scene,this.camera)}}const X=0,V=3,v=16,G=16,y=16,g=4,x=4,$=2;class Q{renderer;player;worker;chunks=new Map;requestedChunks=new Set;texture;chunkMaterial;raycaster=new z;selectionBox;selectedBlock={position:new h,normal:new h,exists:!1};constructor(e,t,s){this.renderer=e,this.player=t,this.texture=s,this.texture.magFilter=w,this.texture.minFilter=w,this.chunkMaterial=new A({map:this.texture,side:S});const o=new F(1.001,1.001,1.001),n=new I({color:16777215,wireframe:!0,transparent:!0,opacity:.5});this.selectionBox=new p(o,n),this.selectionBox.visible=!1,this.renderer.scene.add(this.selectionBox),this.worker=new Worker(new URL(""+new URL("WorldWorker-D2KHgYz0.js",import.meta.url).href,import.meta.url),{type:"module"}),this.worker.onmessage=r=>{r.data.type==="chunkMesh"&&this.addChunkMesh(r.data.chunkKey,r.data.mesh),r.data.type==="worldLoaded"&&(document.getElementById("loading-screen").classList.add("hidden"),this.loadChunksAroundPlayer())},this.worker.postMessage({type:"loadWorld"})}addChunkMesh(e,t){if(this.chunks.has(e)){const c=this.chunks.get(e);this.renderer.scene.remove(c),c.geometry.dispose()}const s=new N;s.setAttribute("position",new m(new Float32Array(t.positions),3)),s.setAttribute("normal",new m(new Float32Array(t.normals),3)),s.setAttribute("uv",new m(new Float32Array(t.uvs),2)),s.setIndex(new m(new Uint32Array(t.indices),1));const o=new p(s,this.chunkMaterial),[n,r,a]=e.split(",").map(Number);o.position.set(n*v,r*G,a*y),o.name=e,this.chunks.set(e,o),this.renderer.scene.add(o),this.requestedChunks.delete(e)}update(){this.loadChunksAroundPlayer(),this.updateRaycaster()}loadChunksAroundPlayer(){const[e,t]=this.getPlayerChunkPosition();for(let s=-g;s<=g;s++)for(let o=-x;o<=x;o++)for(let n=0;n<$;n++){const r=e+s,a=n,c=t+o,u=`${r},${a},${c}`;if(!this.chunks.has(u)&&!this.requestedChunks.has(u)){this.requestedChunks.add(u);const E={type:"generate",chunkX:r,chunkY:a,chunkZ:c,chunkKey:u};this.worker.postMessage(E)}}}getPlayerChunkPosition(){const e=this.player.controls.object.position,t=Math.floor(e.x/v),s=Math.floor(e.z/y);return[t,s]}updateRaycaster(){if(!this.player.controls.isLocked){this.selectionBox.visible=!1,this.selectedBlock.exists=!1;return}this.raycaster.setFromCamera(new D(0,0),this.renderer.camera);const e=this.raycaster.intersectObjects(Array.from(this.chunks.values()),!1);if(e.length>0){const t=e[0],s=t.point,o=t.face.normal,n=new h(Math.floor(s.x-o.x*.5),Math.floor(s.y-o.y*.5),Math.floor(s.z-o.z*.5));this.selectionBox.position.set(n.x+.5,n.y+.5,n.z+.5),this.selectionBox.visible=!0,this.selectedBlock.position.copy(n),this.selectedBlock.normal.copy(o),this.selectedBlock.exists=!0}else this.selectionBox.visible=!1,this.selectedBlock.exists=!1}breakBlock(){if(!this.selectedBlock.exists)return;const{x:e,y:t,z:s}=this.selectedBlock.position,o={type:"setBlock",worldX:e,worldY:t,worldZ:s,blockId:X};this.worker.postMessage(o)}placeBlock(){if(!this.selectedBlock.exists)return;const{position:e,normal:t}=this.selectedBlock,s=e.x+t.x,o=e.y+t.y,n=e.z+t.z,r={type:"setBlock",worldX:s,worldY:o,worldZ:n,blockId:V};this.worker.postMessage(r)}saveWorld(){console.log("Main: ワールド保存をリクエスト..."),this.worker.postMessage({type:"saveWorld"})}}async function J(){const i=document.getElementById("main-canvas");if(!i)throw new Error("Canvas element not found");const e=new K(i),t=new j(e.camera,i),o=await new W().loadAsync("../public/assets/img/textures.png");console.log("Main: テクスチャ読み込み完了");const n=new Q(e,t,o);i.addEventListener("mousedown",c=>{if(t.controls.isLocked)switch(c.button){case 0:n.breakBlock();break;case 2:n.placeBlock();break}}),i.addEventListener("contextmenu",c=>c.preventDefault()),document.getElementById("save-button").addEventListener("click",()=>{n.saveWorld()});function a(){requestAnimationFrame(a),n.update(),e.render(t)}a(),console.log("Main: アプリケーション初期化完了")}J().catch(console.error);
